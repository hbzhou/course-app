image: eclipse-temurin:25.0.2_10-jdk
variables:
  GRADLE_HOME: ${CI_PROJECT_DIR}/api/gradle_home

.base:
  before_script:
    - mkdir -p $GRADLE_HOME
    - chmod +x ./gradlew
  tags:
    - kubernetes

compile-api:
  extends: .base
  stage: compile
  cache:
    - key: ${CI_PROJECT_NAME}-api
      paths:
        - api/gradle_home
      policy: pull-push
    - key: ${CI_PROJECT_NAME}-api-build-${CI_COMMIT_SHORT_SHA}
      paths:
        - api/build
      policy: pull-push
  script:
    - ./gradlew -g ${GRADLE_HOME} classes testClasses

.api-compiled:
  extends: .base
  needs:
    - compile-api
  cache:
    - key: ${CI_PROJECT_NAME}-api
      paths:
        - api/gradle_home
      policy: pull
    - key: ${CI_PROJECT_NAME}-api-build-${CI_COMMIT_SHORT_SHA}
      paths:
        - api/build
      policy: pull

api-unit-test:
  stage: test
  extends: .api-compiled
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_ROOT_PASSWORD: root123
    MYSQL_DATABASE: coursedb
    MYSQL_USER: admin
    MYSQL_PASSWORD: welcome123
    SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/coursedb
    SPRING_DATASOURCE_USERNAME: admin
    SPRING_DATASOURCE_PASSWORD: welcome123
  script:
    - ./gradlew -g ${GRADLE_HOME} :api:test
  artifacts:
    when: on_success
    paths:
      - api/build/reports
      - api/build/test-results
    reports:
      junit:
        - "api/build/test-results/test/*.xml"
    expire_in: 30 days
    expose_as: Test Result Reports

api-build:
    stage: build
    extends: .api-compiled
    needs:
      - api-unit-test
      - compile-ui
    before_script:
      - mkdir -p api/src/main/resources/public
      - cp -r ui/dist/* api/src/main/resources/public/
    script:
      - ./gradlew -g ${GRADLE_HOME} :api:bootJar
    artifacts:
      name: $CI_JOB_NAME-$CI_PIPELINE_ID
      paths:
        - api/build
    when: on_success

api-native-build:
    stage: build
    image: ghcr.io/graalvm/native-image-community:25
    extends: .api-compiled
    needs:
      - api-unit-test
      - compile-ui
    variables:
      KUBERNETES_MEMORY_REQUEST: "4Gi"
      KUBERNETES_MEMORY_LIMIT: "10Gi"
      KUBERNETES_CPU_REQUEST: "2000m"
      KUBERNETES_CPU_LIMIT: "4000m"
    before_script:
      - mkdir -p api/src/main/resources/public
      - cp -r ui/dist/* api/src/main/resources/public/
    script:
      - ./gradlew -g ${GRADLE_HOME} :api:nativeCompile
    artifacts:
      name: $CI_JOB_NAME-$CI_PIPELINE_ID
      paths:
        - api/build
    when: manual
    allow_failure: true